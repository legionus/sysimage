#!/bin/bash -efu
# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2023  Alexey Gladkov <gladkov.alexey@gmail.com>

. "$HOMEDIR"/env

! podman image exists "$IMAGE_BASEIMAGE:latest" ||
	exit 0

set --

[ -z "${BASEIMAGE_FILES-}" ] ||
	set -- "$@" -v "$BASEIMAGE_FILES:/.host/files:z"

podman image build \
	-v "$HOSTDIR":/.host:z \
	-v "$CACHEDIR/$VENDOR":/.host/cache:z \
	"$@" \
	--build-arg verbose="$verbose" \
	--build-arg extra="${BASEIMAGE_PACKAGES-}" \
	--build-arg extra2="${BASEIMAGE_PACKAGES2-}" \
	-t "$IMAGE_BASEIMAGE:latest" \
	-f "$VENDORDIR/$VENDOR/Dockerfile.baseimage"

[ ! -d "$HOSTDIR"/.host/files ] ||
	rm -rf -- "$HOSTDIR":/.host/files
