#!/bin/bash
set -eu

. /.host/sh-functions

mkdir -p -- \
	/aptbox/var/lib/rpm \
	/aptbox/apt/archives/partial

rpmdb --initdb --dbpath "/aptbox/var/lib/rpm"

apt-get -y -qq update

xargs -r apt-get -y \
		-o APT::Get::Download-Only=1 \
		-o Dir::Cache::archives="/aptbox/apt/archives" \
		-o RPM::RootDir="/aptbox" \
	install < /.host/packages

rm -rf -- /.host/rpms
mkdir -- /.host/rpms

find /aptbox/apt/archives -type f -name '*.rpm' -print |
while read -r f; do
	name=$(rpmquery -q --qf '%{NAME}-%{VERSION}-%{RELEASE}.%{ARCH}.rpm\n' -p "$f")
	mv -- "$f" "/.host/rpms/$name"
done
