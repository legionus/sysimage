#!/bin/bash
set -eu

. /.host/sh-functions

def_install_langs=all

mk_exec() {
	{
		printf '#!/bin/sh\n'
		cat
	} > "$1"
	chmod +x -- "$1"
}

run_chroot() {
	unshare -R /image -w / -- "$1" < /dev/null
}

cd /
mkdir $verbose -p -- \
	/aptbox/var/lib/rpm \
	/image/.host/apt/partial \
	/image/dev \
	/image/proc \
	/image/sys \
#

rpmdb --initdb --dbpath "/aptbox/var/lib/rpm"
verbose "Created RPM database in \`./var/lib/rpm/'."

apt-get -y update
apt-get -y \
		-o APT::Get::Download-Only=1 \
		-o Dir::Cache::archives="/image/.host/apt" \
		-o RPM::RootDir="/aptbox" \
	install $PKG_INIT_LIST

for f in /image/.host/apt/*.rpm; do
	rpm2cpio "$f" | cpio --extract --make-directories --sparse --quiet --preserve-modification-time --directory=/image &&
		verbose "Unpacked ${f##*/}." ||
		fatal "Unpack of ${f##*/} failed."
	echo "${f#/image}"
done > /image/.host/apt/rpmlist

mk_exec /image/.host/run.sh <<EOF
# mtab is missing in setup-2.2.2-alt1
touch /etc/mtab

# avoid %_dbapi=1
rm -f /etc/rpm/macros.db1

# glibc-locales is too large
echo '%_install_langs ${INSTALL_LANGS:-$def_install_langs}' >>/etc/rpm/macros

# Force the treatment of scriptlet errors as expected in install checks
echo '%_rpmscript_werror 1' >>/etc/rpm/macros

if [ -x /.host/predb ]; then
	/.host/predb
fi

rpmdb --initdb
EOF

run_chroot /.host/run.sh < /dev/null &&
	verbose 'Created RPM database.' ||
	fatal 'Failed to create RPM database.'

mk_exec /image/.host/run.sh <<EOF
export DURING_INSTALL=1
${EXCLUDE_DOCS:+export RPM_EXCLUDEDOCS=1}
rpm -i $verbose --ignorearch ${EXCLUDE_DOCS:+--excludedocs} --justdb --nodeps /.host/apt/rpmlist
EOF

run_chroot /.host/run.sh < /dev/null &&
	verbose 'Installed initial package list.' ||
	fatal 'Failed to install initial package list.'

rm -rf -- /image/.host/apt

tar -cf /.host/bootstrap.tar --directory /image --numeric-owner --exclude .host .
