#!/bin/bash
# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2023  Alexey Gladkov <gladkov.alexey@gmail.com>

set -eu

export FEATURES="-ipc-sandbox -network-sandbox -pid-sandbox"

set --  -q --ask=n \
	--autounmask=y --autounmask-write=y --autounmask-use=y --autounmask-continue=y

[ -z "${IMAGE_VAR_EMERGE_JOBS-}"         ] || set -- "$@" --jobs "$IMAGE_VAR_EMERGE_JOBS"
[ -z "${IMAGE_VAR_EMERGE_LOAD_AVERAGE-}" ] || set -- "$@" --load-average "$IMAGE_VAR_EMERGE_LOAD_AVERAGE"

if [ -n "${IMAGE_VAR_CACHE_BINPKGS:-}" ]; then
	printf >&2 '%s: %s\n' "$PROG" "using binpkg cache ..."

	if [ -d /etc/portage/binrepos.conf ]; then
		rm -rf -- /.host/binrepos.conf
		mv -f -- /etc/portage/binrepos.conf /.host/binrepos.conf
	fi

	export PKGDIR=/.host/cache/binpkgs

	mkdir -p -- "$PKGDIR"
	:>> "$PKGDIR"/Packages

	mkdir -p -- /etc/portage/binrepos.conf
	cat > /etc/portage/binrepos.conf/gentoobinhost.conf <<-EOF
	[sysimage]
	sync-uri=file://$PKGDIR
	fetchcommand=/usr/bin/curl --fail --output \${DISTDIR}/\${FILE} \${URI}
	resumecommand=/usr/bin/curl -fail --continue-at - --output \${DISTDIR}/\${FILE} \${URI}
	EOF

	# https://wiki.gentoo.org/wiki/Binary_package_guide#Maintaining_the_Packages_file
	#
	# If for some reason binary packages are simply deleted or copied into
	# the packages directory, or the Packages file gets corrupted or
	# deleted, then it must be recreated.
	emaint binhost --fix

	set -- "$@" --usepkg=y --buildpkg=y
fi

export DISTDIR=/.host/cache/distfiles
mkdir -p -- "$DISTDIR"

printf >&2 '%s: %s\n' "$PROG" "running emerge --sync ..."
emerge-webrsync

installed_deps=" "

for spec in ${IMAGE_VAR_OVERLAYS:-}; do
	name="${spec%%:*}"
	method="${spec#*:}"
	method="${method%%:*}"
	url="${spec#$name:$method:}"

	printf >&2 '%s: %s\n' "$PROG" "adding overlay repository $name ($url) ..."

	if [ -n "${installed_deps##* $method *}" ]; then
		pkg=
		case "$method" in
			git)   pkg='dev-vcs/git'    ;;
			rsync) pkg='net-misc/rsync' ;;
		esac
		emerge "$@" "$pkg"
		installed_deps="$installed_deps $method "
	fi

	mkdir -p /etc/portage/repos.conf
	cat > "/etc/portage/repos.conf/$name.conf" <<-EOF
	[$name]
	location = /var/db/repos/$name
	sync-type = $method
	sync-uri = $url
	auto-sync = yes
	priority = 100
	EOF
	emaint sync -r "$name"
done

printf >&2 '%s: %s\n' "$PROG" "installation extra packages  ..."
xargs -r emerge "$@" < /.host/packages

if [ -n "${IMAGE_VAR_CACHE_BINPKGS:-}" ]; then
	rm -rf -- /etc/portage/binrepos.conf

	[ ! -d /.host/binrepos.conf ] ||
		mv -f /.host/binrepos.conf /etc/portage/binrepos.conf
fi
