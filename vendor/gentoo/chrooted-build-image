#!/bin/bash
# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2023  Alexey Gladkov <gladkov.alexey@gmail.com>

set -eu

export FEATURES="-ipc-sandbox -network-sandbox -pid-sandbox ${IMAGE_VAR_EMERGE_IGNORE_COLLISIONS:+-collision-detect -protect-owned}"

automask=( --autounmask=y --autounmask-write=y --autounmask-use=y --autounmask-continue=y )

set -- ${IMAGE_VAR_EMERGE_QUIET:+-q} --ask=n --read-news=n --newuse --verbose-conflicts "${automask[@]}"

[ -z "${IMAGE_VAR_EMERGE_JOBS-}"         ] || set -- "$@" --jobs "$IMAGE_VAR_EMERGE_JOBS"
[ -z "${IMAGE_VAR_EMERGE_LOAD_AVERAGE-}" ] || set -- "$@" --load-average "$IMAGE_VAR_EMERGE_LOAD_AVERAGE"
[ -z "${IMAGE_VAR_CACHE_BINPKGS-}"       ] || set -- "$@" --usepkg=y --buildpkg=y

setup_logs
setup_distfiles
setup_binpkgs

message "running emerge --sync ..."
emerge --sync ${IMAGE_VAR_EMERGE_QUIET:+--quiet}

mkdir -p /etc/portage/sets
cp -v /.host/packages /etc/portage/sets/sysimage

if grep -E -qs \
	-e '^(\s*)sys-apps/gentoo-systemd-integration(\s*)$' \
	-e '^(\s*)sys-apps/systemd(\s*)$' \
	/etc/portage/sets/sysimage;
then
	emerge --deselect sys-apps/openrc sys-apps/sysvinit sys-fs/udev ||:
	emerge --oneshot virtual/udev virtual/libudev
fi

message "installation extra packages ..."
emerge "$@" @sysimage

message "update the @world ..."
emerge "$@" ${IMAGE_VAR_EMERGE_QUIET:+-q} --update --newuse --deep @world

kernels=(`find /usr/src -mindepth 1 -maxdepth 1 -type d -printf '%f\n' | sort -V`)
if [ "${#kernels[*]}" -gt 0 ]; then
	current=
	[ ! -L /usr/src/linux ] ||
		current="$(readlink /usr/src/linux)" ||:

	for value in "${kernels[@]}"; do
		message "need to rebuild kernel modules for $value ..."

		ln -vnsf -- "$value" /usr/src/linux
		emerge ${IMAGE_VAR_EMERGE_QUIET:+-q} --ask=n "${automask[@]}" @module-rebuild
	done

	[ -z "$current" ] ||
		ln -vnsf -- "$current" /usr/src/linux
fi

[ -z "${IMAGE_VAR_REMOVE_BDEPS:-}" ] ||
	emerge --depclean --with-bdeps=n

restore_binpkgs
cleanup_portage /
